# RicianNet 复现与实验记录 (Record.md)

## 1. 环境配置与框架迁移
* **初始问题**：在 Windows 原生环境下使用 TensorFlow 2.11+ 时，无法调用 GPU 资源。
* **根本原因**：Google 官方从 TF 2.11 开始放弃了对 Windows 原生 GPU 的支持，默认只使用 CPU。
* **解决方案**：为保证底层算子的灵活性和开发效率，全面将原论文的 Caffe 架构迁移至 PyTorch，并使用 `cu118` 版本的预编译包，成功激活 GPU 训练。

## 2. 数据管道 (Data Pipeline) 踩坑记录
### 2.1 字符串解码报错
* **报错信息**：`AttributeError: 'str' object has no attribute 'decode'`
* **发生位置**：`utils/data_loader.py` 中的 `cv2.imread()`
* **原因分析**：Python 3 的原生 `str` 已经是 Unicode 编码，不再需要像 Python 2 那样调用 `.decode('utf-8')`。
* **解决方案**：直接移除 `.decode('utf-8')`，将文件绝对路径字符串原样传入 OpenCV。

### 2.2 医学影像格式解析
* **问题描述**：真实的 MRI 数据多为 3D 的 `.mnc` 或 `.nii.gz` 格式，普通图像库无法读取。
* **解决方案**：引入 `nibabel` 库读取 3D 体积矩阵，沿 Axial 轴切片，并加入严格的 Min-Max 归一化（剔除极暗背景），最终映射到 0~255 的 8-bit PNG 图片供网络训练。加入了随机旋转和翻转进行数据增强。

## 3. 模型训练与超参数调试 (Hyperparameter Tuning)
### 3.1 模式崩溃 (Mode Collapse) 与 Loss 停滞
* **现象**：训练初期，平均 Loss 死死卡在 0.097 附近降不下去。模型输出为一片死灰，残差图等于原图。
* **原因分析**：
  1. 论文网络结构的特殊性：为了保留莱斯噪声的非线性特征，第一子网络（Sub-RicianNet1）故意没有加入 Batch Normalization (BN) 层。
  2. PyTorch 的默认卷积权重初始化方式，配合论文原设的极其激进的学习率 (`lr=0.1`) 和 SGD 优化器，导致第一轮反向传播时梯度过大，大量 ReLU 神经元陷入“死亡状态”（即输入持续为负，梯度永远为 0）。
* **解决方案**：放弃原论文的 SGD 优化器，改用自适应动量的 **Adam 优化器**，并将初始学习率下调至 `0.001` 或 `1e-4`。

## 4. 训练数据集问题
### 4.1 数据集亮度偏差
* **问题描述**：应该使用RF0数据集进行训练，原数据集错误地使用了RF20数据。
* **解决方案**：热启动微调 (Warm-start Fine-tuning)，在已经训练过的模型基础上，降低学习率再进行多轮训练来微调偏置。
* **解决结果**：
    实验组 A：RF20 数据集训练，最终 Loss 0.0037，去噪图受亮度偏置干扰。
    实验组 B：RF0 数据集微调，最终 Loss 0.0028，各项指标大幅提升，视觉效果更佳。
### 4.2 数据集样本量小
* **问题描述**: 若只对MRI图像沿Z轴切片，图像样本量比较小，模型泛化能力差
* **解决方案**：



---
**附录：待办事项 (TODO)**
- [x] 跑通单张二维切片的验证集。
- [x] 下载 BrainWeb 真实的 T1/T2/PD 脑部模型切片。
- [ ] 观察 Adam 优化器在真实数据集上的收敛曲线（使用 TensorBoard）。
- [ ] 测试不同噪声水平 (5% - 30%) 下的 PSNR/SSIM 最终指标。

