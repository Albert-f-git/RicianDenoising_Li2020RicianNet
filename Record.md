# RicianNet 复现与实验记录 (Record.md)

## 0. 结果记录
# 0.1 RF20_UNCLEANED(LOSS: 0.0038)
轴状面切片![图片alt](/data/test/brain_test_01.png "轴状面")评估结果：
噪声水平 (Rician)    |       PSNR (dB) | PSNR_after (dB) |            SSIM |      SSIM_after
| ------------: | ------------: | ------------: | ------------: | ------------: |
|              5%    |         25.0380 |         29.2011 |          0.6294 |          0.9052
|              8%    |         20.9411 |         27.8183 |          0.5131 |          0.8731
|             10%    |         18.9999 |         26.8681 |          0.4488 |          0.8399
|             15%    |         15.4714 |         24.7835 |          0.3232 |          0.7675
|             20%    |         12.9729 |         23.1836 |          0.2351 |          0.7199
|             25%    |         11.0376 |         22.2462 |          0.1730 |          0.6860

矢状面切片![图片alt](/data/test/brain_test_02.png "矢状面")评估结果：
噪声水平 (Rician)    |       PSNR (dB) | PSNR_after (dB) |            SSIM |      SSIM_after
| ------------: | ------------: | ------------: | ------------: | ------------: |
|              5%    |         25.0285 |         30.0294 |          0.5980 |          0.8930
|              8%    |         20.9129 |         28.2599 |          0.4729 |          0.8585
|             10%    |         18.9620 |         27.1206 |          0.4063 |          0.8192
|             15%    |         15.4226 |         24.9215 |          0.2836 |          0.7359
|             20%    |         12.9117 |         23.1295 |          0.2037 |          0.6811
|             25%    |         10.9567 |         22.2397 |          0.1497 |          0.6483

# 0.2 RF20_CLEANED(LOSS: 0.0033)
轴状面切片评估结果：
|噪声水平 (Rician)    |       PSNR (dB) | PSNR_after (dB) |            SSIM |      SSIM_after
| ------------: | ------------: | ------------: | ------------: | ------------: |
|              5%    |         25.0380 |         32.0647 |          0.6294 |          0.9196
|              8%    |         20.9411 |         30.2959 |          0.5131 |          0.8895
|             10%    |         18.9999 |         29.1717 |          0.4488 |          0.8633
|             15%    |         15.4714 |         26.9114 |          0.3232 |          0.8015
|             20%    |         12.9729 |         25.1286 |          0.2351 |          0.7500
|             25%    |         11.0376 |         23.7631 |          0.1730 |          0.7032

矢状面切片评估结果：
|噪声水平 (Rician)   |       PSNR (dB) | PSNR_after (dB) |            SSIM |      SSIM_after
| ------------: | ------------: | ------------: | ------------: | ------------: |
|              5%    |         25.0285 |         33.0369 |          0.5980 |          0.9264
|              8%    |         20.9129 |         31.2667 |          0.4729 |          0.9018
|             10%    |         18.9620 |         30.2097 |          0.4063 |          0.8815
|             15%    |         15.4226 |         27.8560 |          0.2836 |          0.8171
|             20%    |         12.9117 |         25.9207 |          0.2037 |          0.7594
|             25%    |         10.9567 |         24.2077 |          0.1497 |          0.7106

# 0.3 RF0_UNCLEANED(LOSS: 0.0028)

轴状面切片评估结果：
|噪声水平 (Rician)    |       PSNR (dB) | PSNR_after (dB) |            SSIM |      SSIM_after
| ------------: | ------------: | ------------: | ------------: | ------------: |
|              5%    |         25.0380 |         31.4213 |          0.6294 |          0.8637
|              8%    |         20.9411 |         29.9340 |          0.5131 |          0.8540
|             10%    |         18.9999 |         28.9002 |          0.4488 |          0.8388
|             15%    |         15.4714 |         26.6731 |          0.3232 |          0.7935
|             20%    |         12.9729 |         25.1276 |          0.2351 |          0.7593
|             25%    |         11.0376 |         23.9910 |          0.1730 |          0.7274

矢状面切片评估结果：
|噪声水平 (Rician)   |       PSNR (dB) | PSNR_after (dB) |            SSIM |      SSIM_after
| ------------: | ------------: | ------------: | ------------: | ------------: |
|            5%     |         25.0285 |         32.1622 |          0.5980 |          0.8274
|            8%     |         20.9129 |         30.7418 |          0.4729 |          0.8435
|            10%    |         18.9620 |         29.7652 |          0.4063 |          0.8377
|            15%    |         15.4226 |         27.5517 |          0.2836 |          0.7997
|            20%    |         12.9117 |         25.7844 |          0.2037 |          0.7592
|            25%    |         10.9567 |         24.1969 |          0.1497 |          0.7233

# 0.4 RF0_CLEANED(LOSS: 0.0032)

轴状面切片评估结果：
|噪声水平 (Rician)    |       PSNR (dB) | PSNR_after (dB) |            SSIM |      SSIM_after
| ------------: | ------------: | ------------: | ------------: | ------------: |
|              5%    |         25.0380 |         31.8665 |          0.6294 |          0.8911
|              8%    |         20.9411 |         30.1918 |          0.5131 |          0.8702
|             10%    |         18.9999 |         29.2209 |          0.4488 |          0.8552
|             15%    |         15.4714 |         27.1692 |          0.3232 |          0.8093
|             20%    |         12.9729 |         25.5532 |          0.2351 |          0.7623
|             25%    |         11.0376 |         24.2122 |          0.1730 |          0.7241

矢状面切片评估结果：
|噪声水平 (Rician)   |       PSNR (dB) | PSNR_after (dB) |            SSIM |      SSIM_after
| ------------: | ------------: | ------------: | ------------: | ------------: |
|              5%    |         25.0285 |         33.1247 |          0.5980 |          0.8976
|              8%    |         20.9129 |         31.4050 |          0.4729 |          0.8839
|             10%    |         18.9620 |         30.4047 |          0.4063 |          0.8728
|             15%    |         15.4226 |         28.1347 |          0.2836 |          0.8315
|             20%    |         12.9117 |         26.0995 |          0.2037 |          0.7869
|             25%    |         10.9567 |         24.4798 |          0.1497 |          0.7394
## 1. 环境配置与框架迁移
* **初始问题**：在 Windows 原生环境下使用 TensorFlow 2.11+ 时，无法调用 GPU 资源。
* **根本原因**：Google 官方从 TF 2.11 开始放弃了对 Windows 原生 GPU 的支持，默认只使用 CPU。
* **解决方案**：为保证底层算子的灵活性和开发效率，全面将原论文的 Caffe 架构迁移至 PyTorch，并使用 `cu118` 版本的预编译包，成功激活 GPU 训练。

## 2. 数据管道 (Data Pipeline) 踩坑记录
### 2.1 字符串解码报错
* **报错信息**：`AttributeError: 'str' object has no attribute 'decode'`
* **发生位置**：`utils/data_loader.py` 中的 `cv2.imread()`
* **原因分析**：Python 3 的原生 `str` 已经是 Unicode 编码，不再需要像 Python 2 那样调用 `.decode('utf-8')`。
* **解决方案**：直接移除 `.decode('utf-8')`，将文件绝对路径字符串原样传入 OpenCV。

### 2.2 医学影像格式解析
* **问题描述**：真实的 MRI 数据多为 3D 的 `.mnc` 或 `.nii.gz` 格式，普通图像库无法读取。
* **解决方案**：引入 `nibabel` 库读取 3D 体积矩阵，沿 Axial 轴切片，并加入严格的 Min-Max 归一化（剔除极暗背景），最终映射到 0~255 的 8-bit PNG 图片供网络训练。加入了随机旋转和翻转进行数据增强。

## 3. 模型训练与超参数调试 (Hyperparameter Tuning)
### 3.1 模式崩溃 (Mode Collapse) 与 Loss 停滞
* **现象**：训练初期，平均 Loss 死死卡在 0.097 附近降不下去。模型输出为一片死灰，残差图等于原图。
* **原因分析**：
  1. 论文网络结构的特殊性：为了保留莱斯噪声的非线性特征，第一子网络（Sub-RicianNet1）故意没有加入 Batch Normalization (BN) 层。
  2. PyTorch 的默认卷积权重初始化方式，配合论文原设的极其激进的学习率 (`lr=0.1`) 和 SGD 优化器，导致第一轮反向传播时梯度过大，大量 ReLU 神经元陷入“死亡状态”（即输入持续为负，梯度永远为 0）。
* **解决方案**：放弃原论文的 SGD 优化器，改用自适应动量的 **Adam 优化器**，并将初始学习率下调至 `0.001` 或 `1e-4`。

## 4. 训练数据集问题
### 4.1 数据集亮度偏差
* **问题描述**：应该使用RF0数据集进行训练，原数据集错误地使用了RF20数据。
* **解决方案**：热启动微调 (Warm-start Fine-tuning)，在已经训练过的模型基础上，降低学习率再进行多轮训练来微调偏置。
* **解决结果**：
    实验组 A：RF20 数据集训练，最终 Loss 0.0037，去噪图受亮度偏置干扰。
    实验组 B：RF0 数据集微调，最终 Loss 0.0028，各项指标大幅提升，视觉效果更佳。

### 4.2 数据集含有废片
* **问题描述**: 切片脚本得到的图片会出现类似下图的废片[图片alt](/data/example/example_01.png "废片")
* **解决方案**：1. 使用K-Means算法分类筛选；2. 使用像素标准差过滤标准差小的(组织匮乏)图片. 方法2效果一般。
* **解决结果**：loss降低至0.0033，但降噪效果大幅提升。

### 4.3 数据集样本量小
* **问题描述**: 若只对MRI图像沿矢状面切片，图像样本量比较小，模型泛化能力差。表现为：相同噪声水平下矢状面去噪效果更好
* **解决方案**：

---
**附录：待办事项 (TODO)**
- [x] 跑通单张二维切片的验证集。
- [x] 下载 BrainWeb 真实的 T1/T2/PD 脑部模型切片。
- [x] 观察 Adam 优化器在真实数据集上的收敛曲线（使用 TensorBoard）。
- [x] 测试不同噪声水平 (5% - 30%) 下的 PSNR/SSIM 最终指标。

